<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± - AI TRPG</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="header">
    <h1>ğŸ“– ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±</h1>
    <p>ì–´ë–¤ ëª¨í—˜ì„ ì›í•˜ì‹œë‚˜ìš”?</p>
  </div>

  <div class="container">
    <!-- Step 1: ì£¼ì œ ì„ íƒ -->
    <div id="step1" class="card">
      <h2>1. ì£¼ì œ ì„ íƒ</h2>
      
      <p style="color: var(--text-secondary); margin-bottom: 20px;">
        ì¶”ì²œ ì¥ë¥´ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì›í•˜ëŠ” ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.
      </p>

      <!-- ì¶”ì²œ ì¥ë¥´ -->
      <div class="grid-4 mb-20">
        <button class="theme-btn" onclick="selectTheme('ì¤‘ì„¸ íŒíƒ€ì§€')">ğŸ° ì¤‘ì„¸ íŒíƒ€ì§€</button>
        <button class="theme-btn" onclick="selectTheme('ì¢€ë¹„ ì•„í¬ì¹¼ë¦½ìŠ¤')">ğŸ§Ÿ ì¢€ë¹„</button>
        <button class="theme-btn" onclick="selectTheme('ìš°ì£¼ SF')">ğŸš€ ìš°ì£¼ SF</button>
        <button class="theme-btn" onclick="selectTheme('ê³µí¬/í˜¸ëŸ¬')">ğŸ‘» í˜¸ëŸ¬</button>
        <button class="theme-btn" onclick="selectTheme('ì‚¬ì´ë²„í‘í¬')">ğŸ¤– ì‚¬ì´ë²„í‘í¬</button>
        <button class="theme-btn" onclick="selectTheme('ì¡°ì„ ì‹œëŒ€ ì‚¬ê·¹')">ğŸ ì¡°ì„ ì‹œëŒ€</button>
        <button class="theme-btn" onclick="selectTheme('ì¶”ë¦¬/ë¯¸ìŠ¤í„°ë¦¬')">ğŸ” ì¶”ë¦¬</button>
        <button class="theme-btn" onclick="selectTheme('í•™ì›/ì¼ìƒ')">ğŸ« í•™ì›ë¬¼</button>
      </div>

      <!-- ì§ì ‘ ì…ë ¥ -->
      <div class="form-group">
        <label for="customTheme">ë˜ëŠ” ì§ì ‘ ì…ë ¥:</label>
        <input type="text" id="customTheme" placeholder="ì˜ˆ: 1920ë…„ëŒ€ ë¯¸êµ­ ê°±ìŠ¤í„°, ì´ì„¸ê³„ ë˜ì „ íƒí—˜ ë“±">
      </div>

      <div class="btn-group">
        <a href="index.html" class="btn btn-secondary">â† ë’¤ë¡œ</a>
        <button class="btn btn-primary btn-large" onclick="generateScenario()">ğŸ² ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±</button>
      </div>
    </div>

    <!-- ë¡œë”© -->
    <div id="loadingSection" class="card hidden">
      <div class="loading">
        <div class="loading-spinner"></div>
        <span>AIê°€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë§Œë“¤ê³  ìˆìŠµë‹ˆë‹¤...</span>
      </div>
      <p class="text-center text-muted">ì„¸ê³„ê´€, ë“±ì¥ì¸ë¬¼, ìŠ¤í† ë¦¬ë¥¼ êµ¬ì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <!-- Step 2: ì‹œë‚˜ë¦¬ì˜¤ ë¯¸ë¦¬ë³´ê¸° -->
    <div id="step2" class="hidden">
      <div class="card">
        <h2>âœ¨ ìƒì„±ëœ ì‹œë‚˜ë¦¬ì˜¤</h2>
        
        <div class="scenario-preview" id="scenarioPreview">
          <!-- JSë¡œ ì±„ì›€ -->
        </div>

        <div class="btn-group mt-20">
          <button class="btn btn-secondary" onclick="regenerate()">ğŸ”„ ë‹¤ì‹œ ìƒì„±</button>
          <button class="btn btn-primary btn-large" onclick="confirmScenario()">âœ… ì´ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì§„í–‰</button>
        </div>
      </div>
    </div>

    <!-- ê¸°ì¡´ ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ -->
    <div class="card mt-20" id="existingScenarios">
      <h2>ğŸ“š ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤</h2>
      <div id="scenarioList">
        <!-- JSë¡œ ì±„ì›€ -->
      </div>
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script src="js/api.js"></script>
  <script>
    let currentTheme = '';
    let generatedScenario = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ
    document.addEventListener('DOMContentLoaded', () => {
      loadExistingScenarios();
      
      // Enter í‚¤ë¡œ ìƒì„±
      document.getElementById('customTheme').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') generateScenario();
      });
    });

    // í…Œë§ˆ ì„ íƒ
    function selectTheme(theme) {
      currentTheme = theme;
      document.getElementById('customTheme').value = theme;
      
      // ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent.includes(theme.split(' ')[0]) || btn.textContent.includes(theme)) {
          btn.classList.add('selected');
        }
      });
    }

    // ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
    async function generateScenario() {
      const theme = document.getElementById('customTheme').value.trim() || currentTheme;
      
      if (!theme) {
        alert('ì£¼ì œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // UI ìƒíƒœ ë³€ê²½
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('loadingSection').classList.remove('hidden');
      document.getElementById('step2').classList.add('hidden');

      try {
        const scenario = await API.generateScenario(theme);
        scenario.theme = theme;
        generatedScenario = scenario;
        
        displayScenario(scenario);
        
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
      } catch (error) {
        alert('ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
      }
    }

    // ì‹œë‚˜ë¦¬ì˜¤ í‘œì‹œ
    function displayScenario(scenario) {
      const preview = document.getElementById('scenarioPreview');
      
      preview.innerHTML = `
        <h3>${scenario.title}</h3>
        
        <div class="preview-section">
          <h4>ğŸŒ ì„¸ê³„ê´€</h4>
          <p>${scenario.setting}</p>
        </div>
        
        <div class="preview-section">
          <h4>ğŸ¯ ëª©í‘œ</h4>
          <p>${scenario.goal}</p>
        </div>
        
        <div class="preview-section">
          <h4>ğŸ“ ì£¼ìš” ì¥ì†Œ</h4>
          <div class="tag-list">
            ${(scenario.locations || []).map(loc => `<span class="tag">${loc}</span>`).join('')}
          </div>
        </div>
        
        <div class="preview-section">
          <h4>ğŸ‘¥ ë“±ì¥ì¸ë¬¼ (NPC)</h4>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${(scenario.npcs || []).map(npc => `
              <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                <strong>${npc.name}</strong> - ${npc.role}<br>
                <span class="text-muted">${npc.personality}</span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="preview-section">
          <h4>âš ï¸ ìœ„í˜‘ ìš”ì†Œ</h4>
          <div class="tag-list">
            ${(scenario.threats || []).map(t => `<span class="tag" style="background: rgba(239, 68, 68, 0.2);">${t}</span>`).join('')}
          </div>
        </div>
        
        ${scenario.items ? `
        <div class="preview-section">
          <h4>ğŸ’ íšë“ ê°€ëŠ¥ ì•„ì´í…œ</h4>
          <div class="tag-list">
            ${scenario.items.map(item => `<span class="tag" style="background: rgba(74, 222, 128, 0.2);">${item}</span>`).join('')}
          </div>
        </div>
        ` : ''}
        
        ${scenario.starting_scene ? `
        <div class="preview-section">
          <h4>ğŸ¬ ì‹œì‘ ì¥ë©´</h4>
          <p style="font-style: italic; color: var(--text-secondary);">"${scenario.starting_scene}"</p>
        </div>
        ` : ''}
      `;
    }

    // ë‹¤ì‹œ ìƒì„±
    function regenerate() {
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step1').classList.remove('hidden');
    }

    // ì‹œë‚˜ë¦¬ì˜¤ í™•ì •
    function confirmScenario() {
      if (!generatedScenario) {
        alert('ìƒì„±ëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const saved = Storage.saveScenario(generatedScenario);
      
      // ìºë¦­í„° ìƒì„± í˜ì´ì§€ë¡œ ì´ë™ (ì‹œë‚˜ë¦¬ì˜¤ ID ì „ë‹¬)
      window.location.href = `character.html?scenario=${saved.id}`;
    }

    // ê¸°ì¡´ ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ
    function loadExistingScenarios() {
      const scenarios = Storage.getScenarios();
      const listDiv = document.getElementById('scenarioList');

      if (scenarios.length === 0) {
        listDiv.innerHTML = '<p class="text-muted">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      listDiv.innerHTML = scenarios.map(s => `
        <div class="save-item">
          <div class="save-info">
            <h4>${s.title}</h4>
            <p>${s.theme || 'ì•Œ ìˆ˜ ì—†ìŒ'} Â· ${formatDate(s.created_at)}</p>
          </div>
          <div class="save-actions">
            <button class="btn btn-primary" onclick="useScenario('${s.id}')">ì„ íƒ</button>
            <button class="btn btn-secondary" onclick="deleteScenario('${s.id}')">ì‚­ì œ</button>
          </div>
        </div>
      `).join('');
    }

    // ê¸°ì¡´ ì‹œë‚˜ë¦¬ì˜¤ ì‚¬ìš©
    function useScenario(id) {
      window.location.href = `character.html?scenario=${id}`;
    }

    // ì‹œë‚˜ë¦¬ì˜¤ ì‚­ì œ
    function deleteScenario(id) {
      if (confirm('ì´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        Storage.deleteScenario(id);
        loadExistingScenarios();
      }
    }

    // ë‚ ì§œ í¬ë§·
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ko-KR', {
        month: 'short',
        day: 'numeric'
      });
    }
  </script>
</body>
</html>
