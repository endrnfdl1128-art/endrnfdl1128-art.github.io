<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨í—˜ ì¤‘... - AI TRPG</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="game-container">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
      <!-- ìºë¦­í„° ì •ë³´ -->
      <div class="character-panel">
        <h3>ğŸ§™ <span id="charName">ìºë¦­í„°</span></h3>
        <p class="text-muted" id="charClass">ì§ì—…</p>

        <!-- HP ë°” -->
        <div class="hp-bar">
          <div class="hp-bar-fill healthy" id="hpBar" style="width: 100%;">
            <span id="hpText">100/100</span>
          </div>
        </div>

        <!-- ìŠ¤íƒ¯ -->
        <div class="stats-grid">
          <div class="stat-item">
            <span class="name">ğŸ’ª í˜</span>
            <span class="value" id="statStr">10</span>
          </div>
          <div class="stat-item">
            <span class="name">ğŸƒ ë¯¼ì²©</span>
            <span class="value" id="statAgi">10</span>
          </div>
          <div class="stat-item">
            <span class="name">ğŸ§  ì§€ëŠ¥</span>
            <span class="value" id="statInt">10</span>
          </div>
          <div class="stat-item">
            <span class="name">ğŸ€ í–‰ìš´</span>
            <span class="value" id="statLuck">10</span>
          </div>
        </div>
      </div>

      <!-- ì¸ë²¤í† ë¦¬ -->
      <div class="character-panel">
        <h3>ğŸ’ ì†Œì§€í’ˆ</h3>
        <ul class="inventory-list" id="inventoryList">
          <!-- JSë¡œ ì±„ì›€ -->
        </ul>
      </div>

      <!-- ê²Œì„ ë©”ë‰´ -->
      <div class="character-panel">
        <h3>âš™ï¸ ë©”ë‰´</h3>

        <!-- ì´ë¯¸ì§€ ì„¤ì • -->
        <div class="image-settings">
          <label>ğŸ–¼ï¸ ì¥ë©´ ì´ë¯¸ì§€</label>
          <div class="image-mode-select">
            <button class="image-mode-btn" data-mode="off" onclick="setImageMode('off')">ë„ê¸°</button>
            <button class="image-mode-btn" data-mode="pollinations" onclick="setImageMode('pollinations')">ê¸°ë³¸</button>
            <!-- <button class="image-mode-btn" data-mode="gemini" onclick="setImageMode('gemini')">ê³ ê¸‰</button> -->
          </div>
        </div>

        <button class="btn btn-secondary btn-block" onclick="saveGame()" style="margin-bottom: 8px;">ğŸ’¾ ì €ì¥</button>
        <button class="btn btn-secondary btn-block" onclick="showScenarioInfo()" style="margin-bottom: 8px;">ğŸ“– ì‹œë‚˜ë¦¬ì˜¤
          ì •ë³´</button>
        <button class="btn btn-secondary btn-block" onclick="quitGame()">ğŸšª ë‚˜ê°€ê¸°</button>
      </div>
    </div>

    <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
    <div class="game-main">
      <!-- í—¤ë” -->
      <div class="game-header">
        <h2 id="scenarioTitle">ğŸ² ëª¨í—˜ ì¤‘</h2>
        <div class="danger-indicator safe" id="dangerIndicator">ì•ˆì „</div>
      </div>

      <!-- ì¥ë©´ ì´ë¯¸ì§€ -->
      <div class="scene-image-container" id="sceneImageContainer" style="display: none;">
        <img src="" alt="ì¥ë©´ ì´ë¯¸ì§€" class="scene-image" id="sceneImage">
        <div class="image-loading-overlay" id="imageLoading" style="display: none;">
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>ì´ë¯¸ì§€ ìƒì„± ì¤‘...</span>
          </div>
        </div>
      </div>

      <!-- ê²Œì„ ë¡œê·¸ -->
      <div class="game-log" id="gameLog">
        <!-- JSë¡œ ì±„ì›€ -->
      </div>

      <!-- ë¡œë”© í‘œì‹œ -->
      <div id="loadingIndicator" class="hidden" style="padding: 16px; text-align: center;">
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
        </div>
      </div>

      <!-- ì…ë ¥ ì˜ì—­ -->
      <div class="game-input">
        <input type="text" id="actionInput" placeholder="ë¬´ì—‡ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜ˆ: ë¬¸ì„ ì—°ë‹¤, ì£¼ë³€ì„ ì‚´í•€ë‹¤)">
        <button class="btn btn-primary" id="submitBtn" onclick="submitAction()">í–‰ë™</button>
        <button class="btn btn-secondary" onclick="rollCustomDice()">ğŸ²</button>
      </div>
    </div>
  </div>

  <!-- ì£¼ì‚¬ìœ„ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="diceModal">
    <div class="modal">
      <h2>ğŸ² ì£¼ì‚¬ìœ„ íŒì •</h2>
      <p id="rollReason">íŒì • ì¤‘...</p>
      <div class="dice-result" id="diceResult">?</div>
      <div class="roll-details" id="rollDetails">
        <!-- ì£¼ì‚¬ìœ„ ê²°ê³¼ ìƒì„¸ -->
      </div>
      <button class="btn btn-primary" onclick="closeDiceModal()">í™•ì¸</button>
    </div>
  </div>

  <!-- ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="scenarioModal">
    <div class="modal" style="max-width: 600px; text-align: left;">
      <h2>ğŸ“– ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´</h2>
      <div id="scenarioInfo">
        <!-- JSë¡œ ì±„ì›€ -->
      </div>
      <button class="btn btn-primary mt-20" onclick="closeScenarioModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ì €ì¥ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="saveModal">
    <div class="modal">
      <h2>ğŸ’¾ ê²Œì„ ì €ì¥</h2>
      <div class="form-group">
        <label for="saveName">ì €ì¥ ì´ë¦„</label>
        <input type="text" id="saveName" placeholder="ì €ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      <div class="btn-group" style="justify-content: center;">
        <button class="btn btn-secondary" onclick="closeSaveModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="confirmSave()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script src="js/api.js"></script>
  <script>
    let gameState = null;
    let isProcessing = false;
    let pendingRoll = null; // ëŒ€ê¸° ì¤‘ì¸ ì£¼ì‚¬ìœ„ íŒì •
    let imageMode = 'off'; // ì´ë¯¸ì§€ ëª¨ë“œ

    // í˜ì´ì§€ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
      loadGame();
      loadImageSettings();

      // Enter í‚¤ë¡œ í–‰ë™
      document.getElementById('actionInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isProcessing) submitAction();
      });
    });

    // ì´ë¯¸ì§€ ì„¤ì • ë¡œë“œ
    function loadImageSettings() {
      imageMode = Storage.getImageMode();
      updateImageModeUI();
    }

    // ì´ë¯¸ì§€ ëª¨ë“œ ì„¤ì •
    function setImageMode(mode) {
      imageMode = mode;
      Storage.setImageMode(mode);
      updateImageModeUI();

      // ì´ë¯¸ì§€ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€
      const container = document.getElementById('sceneImageContainer');
      if (mode === 'off') {
        container.style.display = 'none';
      }
    }

    // ì´ë¯¸ì§€ ëª¨ë“œ UI ì—…ë°ì´íŠ¸
    function updateImageModeUI() {
      document.querySelectorAll('.image-mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === imageMode);
      });
    }

    // ì¥ë©´ ì´ë¯¸ì§€ ìƒì„± ë° í‘œì‹œ
    async function showSceneImage(imagePrompt) {
      if (imageMode === 'off' || !imagePrompt) {
        document.getElementById('sceneImageContainer').style.display = 'none';
        return;
      }

      const container = document.getElementById('sceneImageContainer');
      const img = document.getElementById('sceneImage');
      const loading = document.getElementById('imageLoading');

      // ë¡œë”© í‘œì‹œ
      container.style.display = 'block';
      loading.style.display = 'flex';
      img.classList.add('loading');

      try {
        const theme = gameState?.scenario?.theme || 'fantasy';
        const imageUrl = await API.getImageUrl(imagePrompt, imageMode, theme);

        if (imageUrl) {
          // ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ
          const tempImg = new Image();
          tempImg.onload = () => {
            img.src = imageUrl;
            img.classList.remove('loading');
            loading.style.display = 'none';
          };
          tempImg.onerror = () => {
            console.error('Image load failed');
            container.style.display = 'none';
          };
          tempImg.src = imageUrl;
        } else {
          container.style.display = 'none';
        }
      } catch (error) {
        console.error('Image generation error:', error);
        container.style.display = 'none';
      }
    }

    // ê²Œì„ ë¡œë“œ
    function loadGame() {
      gameState = Storage.getCurrentGame();

      if (!gameState) {
        alert('ì§„í–‰ ì¤‘ì¸ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤.');
        window.location.href = 'index.html';
        return;
      }

      updateUI();
      renderHistory();

      // ì²« ì‹œì‘ì´ë©´ ì˜¤í”„ë‹ í‘œì‹œ
      if (gameState.history.length === 0) {
        startGame();
      }
    }

    // ê²Œì„ ì‹œì‘ (ì²« ì¥ë©´)
    async function startGame() {
      const scenario = gameState.scenario;
      const character = gameState.character;

      // ì‹œì‘ ì¥ë©´ì´ ìˆìœ¼ë©´ í‘œì‹œ
      if (scenario.starting_scene) {
        addLogEntry('gm', scenario.starting_scene);
        Storage.addToHistory('gm', scenario.starting_scene);

        // ì²« ì¥ë©´ ì´ë¯¸ì§€ ìƒì„±
        const startingImagePrompt = `${scenario.setting}, ${scenario.theme || 'fantasy'} scene, cinematic`;
        showSceneImage(startingImagePrompt);
      } else {
        // ì—†ìœ¼ë©´ AIì—ê²Œ ì²« ì¥ë©´ ìš”ì²­
        setLoading(true);
        try {
          const result = await API.processAction(gameState, '[ê²Œì„ ì‹œì‘] ì²« ì¥ë©´ì„ ë¬˜ì‚¬í•´ì£¼ì„¸ìš”.');
          addLogEntry('gm', result.narration);
          Storage.addToHistory('gm', result.narration);
          updateDanger(result.danger_level);

          // ì²« ì¥ë©´ ì´ë¯¸ì§€ ìƒì„±
          if (result.image_prompt) {
            showSceneImage(result.image_prompt);
          }
        } catch (error) {
          addLogEntry('system', 'âš ï¸ ì˜¤ë¥˜: ' + error.message);
        }
        setLoading(false);
      }
    }

    // UI ì—…ë°ì´íŠ¸
    function updateUI() {
      const char = gameState.character;
      const scenario = gameState.scenario;

      // ìºë¦­í„° ì •ë³´
      document.getElementById('charName').textContent = char.name;
      document.getElementById('charClass').textContent = char.class;

      // HP
      updateHP();

      // ìŠ¤íƒ¯
      document.getElementById('statStr').textContent = char.stats.strength;
      document.getElementById('statAgi').textContent = char.stats.agility;
      document.getElementById('statInt').textContent = char.stats.intelligence;
      document.getElementById('statLuck').textContent = char.stats.luck;

      // ì¸ë²¤í† ë¦¬
      updateInventory();

      // ì‹œë‚˜ë¦¬ì˜¤ ì œëª©
      document.getElementById('scenarioTitle').textContent = scenario.title;
      document.title = `${scenario.title} - AI TRPG`;

      // ìœ„í—˜ë„
      updateDanger(gameState.danger_level);
    }

    // HP ì—…ë°ì´íŠ¸
    function updateHP() {
      const char = gameState.character;
      const hp = char.stats.hp;
      const maxHp = char.stats.maxHp;
      const percent = (hp / maxHp) * 100;

      const hpBar = document.getElementById('hpBar');
      const hpText = document.getElementById('hpText');

      hpBar.style.width = percent + '%';
      hpText.textContent = `${hp}/${maxHp}`;

      // HPì— ë”°ë¥¸ ìƒ‰ìƒ
      hpBar.classList.remove('healthy', 'warning', 'danger');
      if (percent > 60) {
        hpBar.classList.add('healthy');
      } else if (percent > 30) {
        hpBar.classList.add('warning');
      } else {
        hpBar.classList.add('danger');
      }

      // ì‚¬ë§ ì²´í¬
      if (hp <= 0) {
        gameOver();
      }
    }

    // ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸
    function updateInventory() {
      const list = document.getElementById('inventoryList');
      const inventory = gameState.character.inventory || [];

      if (inventory.length === 0) {
        list.innerHTML = '<li class="text-muted">ë¹ˆ ê°€ë°©</li>';
      } else {
        list.innerHTML = inventory.map(item => `<li>â€¢ ${item}</li>`).join('');
      }
    }

    // ìœ„í—˜ë„ ì—…ë°ì´íŠ¸
    function updateDanger(level) {
      const indicator = document.getElementById('dangerIndicator');
      indicator.classList.remove('safe', 'caution', 'danger');

      switch (level) {
        case 'danger':
          indicator.classList.add('danger');
          indicator.textContent = 'ìœ„í—˜';
          break;
        case 'caution':
          indicator.classList.add('caution');
          indicator.textContent = 'ì£¼ì˜';
          break;
        default:
          indicator.classList.add('safe');
          indicator.textContent = 'ì•ˆì „';
      }

      gameState.danger_level = level;
    }

    // íˆìŠ¤í† ë¦¬ ë Œë”ë§
    function renderHistory() {
      const log = document.getElementById('gameLog');
      log.innerHTML = '';

      gameState.history.forEach(entry => {
        addLogEntry(entry.role, entry.text, false);
      });

      scrollToBottom();
    }

    // ë¬¸ìì—´ì„ ìƒ‰ìƒìœ¼ë¡œ ë³€í™˜ (í•´ì‹œ)
    function stringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }

      // HSLì„ ì‚¬ìš©í•˜ì—¬ íŒŒìŠ¤í…” í†¤ ìƒ‰ìƒ ìƒì„± (ì±„ë„ì™€ ëª…ë„ë¥¼ ë†’ê²Œ ê³ ì •)
      const h = Math.abs(hash % 360);
      return `hsl(${h}, 70%, 65%)`; // ì±„ë„ 70%, ëª…ë„ 65%ë¡œ ë°ê³  ì„ ëª…í•˜ê²Œ
    }

    // ë¡œê·¸ í•­ëª© ì¶”ê°€
    function addLogEntry(role, text, name = null, scroll = true) {
      const log = document.getElementById('gameLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${role}`;

      let roleLabel = '';
      let styleAttr = '';

      switch (role) {
        case 'gm':
          roleLabel = 'ğŸ­ ê²Œì„ ë§ˆìŠ¤í„°';
          break;
        case 'player':
          roleLabel = 'ğŸ‘¤ ë‚˜';
          break;
        case 'system':
          roleLabel = 'ğŸ² ì‹œìŠ¤í…œ';
          break;
        case 'npc':
          const npcName = name || 'NPC';
          const npcColor = stringToColor(npcName);
          roleLabel = `<span style="color: ${npcColor}">ğŸ’¬ ${npcName}</span>`;
          styleAttr = `style="border-left-color: ${npcColor}; background: linear-gradient(90deg, ${npcColor}11, var(--bg-card))"`;
          break;
      }

      entry.innerHTML = `
        <div class="role">${roleLabel}</div>
        <div class="text">${text}</div>
      `;

      // NPCì¼ ê²½ìš° ìŠ¤íƒ€ì¼ ì§ì ‘ ì ìš©
      if (role === 'npc') {
        const npcName = name || 'NPC';
        const npcColor = stringToColor(npcName);
        entry.style.borderLeftColor = npcColor;
        // ë°°ê²½ì— ì‚´ì§ í‹´íŠ¸ ì£¼ê¸°
        entry.style.background = `linear-gradient(90deg, ${npcColor}1a, var(--bg-card))`;
      }

      log.appendChild(entry);
      if (scroll) scrollToBottom();
    }

    // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ (ë Œë”ë§ íƒ€ì´ë° ê³ ë ¤)
    function scrollToBottom() {
      const log = document.getElementById('gameLog');

      // ì¦‰ì‹œ ì‹¤í–‰
      log.scrollTop = log.scrollHeight;

      // ì•½ê°„ì˜ ì§€ì—° í›„ ì¬ì‹¤í–‰ (ì´ë¯¸ì§€ ë¡œë“œë‚˜ DOM ë Œë”ë§ ì™„ë£Œ í›„)
      requestAnimationFrame(() => {
        log.scrollTo({
          top: log.scrollHeight,
          behavior: 'smooth'
        });
      });
    }

    // í–‰ë™ ì œì¶œ
    async function submitAction() {
      const input = document.getElementById('actionInput');
      const action = input.value.trim();

      if (!action || isProcessing) return;

      // í”Œë ˆì´ì–´ í–‰ë™ í‘œì‹œ
      addLogEntry('player', action);
      Storage.addToHistory('player', action);
      input.value = '';

      // AI ì‘ë‹µ ìš”ì²­
      setLoading(true);

      try {
        // ìµœì‹  ê²Œì„ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
        gameState = Storage.getCurrentGame();

        const result = await API.processAction(gameState, action);

        // ì£¼ì‚¬ìœ„ íŒì •ì´ í•„ìš”í•œ ê²½ìš°
        if (result.requires_roll && result.roll_type) {
          pendingRoll = {
            action: action,
            rollType: result.roll_type,
            difficulty: result.roll_difficulty || 12
          };

          // íŒì • í•„ìš” ì„œìˆ 
          addLogEntry('gm', result.narration);
          Storage.addToHistory('gm', result.narration);

          // NPC ëŒ€ì‚¬ ì²˜ë¦¬
          if (result.dialogues && result.dialogues.length > 0) {
            result.dialogues.forEach(d => {
              addLogEntry('npc', d.text, d.speaker);
              Storage.addToHistory('npc', `${d.speaker}: ${d.text}`);
            });
          }

          const statName = getStatName(result.roll_type);
          addLogEntry('system', `ğŸ² ${statName} íŒì •ì´ í•„ìš”í•©ë‹ˆë‹¤! (ëª©í‘œ: ${result.roll_difficulty}) ì£¼ì‚¬ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
          Storage.addToHistory('system', `${statName} íŒì • í•„ìš” (ëª©í‘œ: ${result.roll_difficulty})`);

        } else {
          // ì¼ë°˜ ì‘ë‹µ
          addLogEntry('gm', result.narration);
          Storage.addToHistory('gm', result.narration);

          // NPC ëŒ€ì‚¬ ì²˜ë¦¬
          if (result.dialogues && result.dialogues.length > 0) {
            result.dialogues.forEach(d => {
              addLogEntry('npc', d.text, d.speaker);
              Storage.addToHistory('npc', `${d.speaker}: ${d.text}`);
            });
          }

          // ìƒíƒœ ë³€ê²½ ì ìš©
          applyStateChanges(result);

          // ì¥ë©´ ì´ë¯¸ì§€ ìƒì„±
          if (result.image_prompt) {
            showSceneImage(result.image_prompt);
          }
        }

        updateDanger(result.danger_level || 'safe');

      } catch (error) {
        addLogEntry('system', 'âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }

      setLoading(false);
    }

    // ìƒíƒœ ë³€ê²½ ì ìš©
    function applyStateChanges(result) {
      let updated = false;

      if (result.damage_taken > 0) {
        Storage.updateCharacterState({ damage: result.damage_taken });
        addLogEntry('system', `ğŸ’” ${result.damage_taken} í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤!`);
        updated = true;
      }

      if (result.items_gained && result.items_gained.length > 0) {
        Storage.updateCharacterState({ addItems: result.items_gained });
        addLogEntry('system', `ğŸ íšë“: ${result.items_gained.join(', ')}`);
        updated = true;
      }

      if (result.items_lost && result.items_lost.length > 0) {
        Storage.updateCharacterState({ removeItems: result.items_lost });
        addLogEntry('system', `ğŸ“¤ ìƒìŒ: ${result.items_lost.join(', ')}`);
        updated = true;
      }

      if (updated) {
        gameState = Storage.getCurrentGame();
        updateUI();
      }
    }

    // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°
    async function rollCustomDice() {
      if (!pendingRoll) {
        // ëŒ€ê¸° ì¤‘ì¸ íŒì •ì´ ì—†ìœ¼ë©´ í–‰ìš´ ì²´í¬
        addLogEntry('system', 'ğŸ² í–‰ìš´ ì²´í¬! (ì¼ë°˜ ì£¼ì‚¬ìœ„)');
        const result = await API.rollDice(gameState.character.stats.luck, 10);
        showDiceResult('í–‰ìš´ ì²´í¬', result);
        return;
      }

      // ëŒ€ê¸° ì¤‘ì¸ íŒì • ì²˜ë¦¬
      const stat = gameState.character.stats[pendingRoll.rollType];
      const result = await API.rollDice(stat, pendingRoll.difficulty);

      showDiceResult(`${getStatName(pendingRoll.rollType)} íŒì •`, result);

      // íŒì • ê²°ê³¼ì— ë”°ë¥¸ ì„œìˆ  ìš”ì²­
      setLoading(true);
      try {
        const narration = await API.getRollNarration(
          gameState,
          pendingRoll.action,
          result
        );

        addLogEntry('gm', narration.narration);
        Storage.addToHistory('gm', narration.narration);

        // NPC ëŒ€ì‚¬ ì²˜ë¦¬
        if (narration.dialogues && narration.dialogues.length > 0) {
          narration.dialogues.forEach(d => {
            addLogEntry('npc', d.text, d.speaker);
            Storage.addToHistory('npc', `${d.speaker}: ${d.text}`);
          });
        }

        applyStateChanges(narration);
        updateDanger(narration.danger_level || gameState.danger_level);

        // ì¥ë©´ ì´ë¯¸ì§€ ìƒì„±
        if (narration.image_prompt) {
          showSceneImage(narration.image_prompt);
        }

      } catch (error) {
        // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€
        if (result.is_success) {
          addLogEntry('gm', 'í–‰ë™ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.');
        } else {
          addLogEntry('gm', 'í–‰ë™ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤...');
        }
      }
      setLoading(false);

      pendingRoll = null;
    }

    // ì£¼ì‚¬ìœ„ ê²°ê³¼ í‘œì‹œ
    function showDiceResult(reason, result) {
      const modal = document.getElementById('diceModal');
      const resultDiv = document.getElementById('diceResult');
      const detailsDiv = document.getElementById('rollDetails');

      document.getElementById('rollReason').textContent = reason;

      // ê²°ê³¼ í‘œì‹œ
      resultDiv.textContent = result.total;
      resultDiv.classList.remove('success', 'failure', 'critical');

      if (result.is_critical) {
        resultDiv.classList.add('critical');
        resultDiv.textContent = result.total + ' â˜…';
      } else if (result.is_success) {
        resultDiv.classList.add('success');
      } else {
        resultDiv.classList.add('failure');
      }

      // ìƒì„¸ ì •ë³´
      let statusText = result.is_critical ? 'ğŸŒŸ ëŒ€ì„±ê³µ!' :
        result.is_fumble ? 'ğŸ’€ ëŒ€ì‹¤íŒ¨!' :
          result.is_success ? 'âœ… ì„±ê³µ!' : 'âŒ ì‹¤íŒ¨';

      detailsDiv.innerHTML = `
        ì£¼ì‚¬ìœ„: ${result.roll} + ë³´ë„ˆìŠ¤: ${result.bonus} = ${result.total}<br>
        ëª©í‘œ ìˆ˜ì¹˜: ${result.difficulty}<br>
        <strong>${statusText}</strong>
      `;

      // ë¡œê·¸ì—ë„ ê¸°ë¡
      Storage.addToHistory('system', `ğŸ² ${reason}: ${result.roll}+${result.bonus}=${result.total} (ëª©í‘œ ${result.difficulty}) â†’ ${statusText}`);

      modal.classList.add('active');
    }

    // ìŠ¤íƒ¯ ì´ë¦„ ë³€í™˜
    function getStatName(type) {
      const names = {
        strength: 'ğŸ’ª í˜',
        agility: 'ğŸƒ ë¯¼ì²©',
        intelligence: 'ğŸ§  ì§€ëŠ¥',
        luck: 'ğŸ€ í–‰ìš´'
      };
      return names[type] || type;
    }

    // ì£¼ì‚¬ìœ„ ëª¨ë‹¬ ë‹«ê¸°
    function closeDiceModal() {
      document.getElementById('diceModal').classList.remove('active');
    }

    // ë¡œë”© ìƒíƒœ
    function setLoading(loading) {
      isProcessing = loading;
      document.getElementById('loadingIndicator').classList.toggle('hidden', !loading);
      document.getElementById('submitBtn').disabled = loading;
      document.getElementById('actionInput').disabled = loading;
    }

    // ê²Œì„ ì €ì¥
    function saveGame() {
      const modal = document.getElementById('saveModal');
      document.getElementById('saveName').value = gameState.scenario.title + ' - ' + new Date().toLocaleDateString('ko-KR');
      modal.classList.add('active');
    }

    function confirmSave() {
      const name = document.getElementById('saveName').value.trim();
      if (!name) {
        alert('ì €ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      Storage.saveGame(name);
      closeSaveModal();
      addLogEntry('system', 'ğŸ’¾ ê²Œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function closeSaveModal() {
      document.getElementById('saveModal').classList.remove('active');
    }

    // ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´
    function showScenarioInfo() {
      const scenario = gameState.scenario;
      const infoDiv = document.getElementById('scenarioInfo');

      infoDiv.innerHTML = `
        <h3 style="color: var(--accent); margin-bottom: 16px;">${scenario.title}</h3>
        
        <p><strong>ğŸŒ ì„¸ê³„ê´€:</strong><br>${scenario.setting}</p>
        <p style="margin-top: 12px;"><strong>ğŸ¯ ëª©í‘œ:</strong><br>${scenario.goal}</p>
        
        <p style="margin-top: 12px;"><strong>ğŸ“ ì¥ì†Œ:</strong><br>
        ${(scenario.locations || []).join(', ')}</p>
        
        <p style="margin-top: 12px;"><strong>ğŸ‘¥ NPC:</strong></p>
        <ul style="margin-left: 20px;">
          ${(scenario.npcs || []).map(npc => `<li><strong>${npc.name}</strong> (${npc.role}) - ${npc.personality}</li>`).join('')}
        </ul>
        
        <p style="margin-top: 12px;"><strong>âš ï¸ ìœ„í˜‘:</strong><br>
        ${(scenario.threats || []).join(', ')}</p>
      `;

      document.getElementById('scenarioModal').classList.add('active');
    }

    function closeScenarioModal() {
      document.getElementById('scenarioModal').classList.remove('active');
    }

    // ê²Œì„ ë‚˜ê°€ê¸°
    function quitGame() {
      if (confirm('ê²Œì„ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì €ì¥í•˜ì§€ ì•Šì€ ì§„í–‰ ìƒí™©ì€ ìœ ì§€ë©ë‹ˆë‹¤.')) {
        window.location.href = 'index.html';
      }
    }

    // ê²Œì„ ì˜¤ë²„
    function gameOver() {
      addLogEntry('system', 'ğŸ’€ ìºë¦­í„°ê°€ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤... ê²Œì„ ì˜¤ë²„');
      document.getElementById('actionInput').disabled = true;
      document.getElementById('submitBtn').disabled = true;

      setTimeout(() => {
        if (confirm('ìºë¦­í„°ê°€ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          Storage.clearCurrentGame();
          window.location.href = 'index.html';
        }
      }, 2000);
    }
  </script>
</body>

</html>